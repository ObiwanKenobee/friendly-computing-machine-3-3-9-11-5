version: 1.0
runtime: nodejs18

source:
  directory: /

build:
  commands:
    pre_build:
      - echo "ğŸ” Pre-build validation starting..."
      - node --version
      - npm --version
      - echo "ğŸ“‹ Checking package.json integrity..."
      - test -f package.json || (echo "âŒ package.json not found" && exit 1)
      - test -f package-lock.json || (echo "âš ï¿½ï¿½ package-lock.json not found, proceeding with caution" && npm install --package-lock-only)
      - echo "âœ… Pre-build validation complete"
    build:
      - echo "ğŸš€ Starting QuantumVest Enterprise build process..."
      - echo "ğŸ§¹ Cleaning previous builds and caches..."
      - rm -rf dist/ || true
      - rm -rf node_modules/.cache/ || true
      - rm -rf node_modules/.vite/ || true
      - echo "ğŸ“¦ Installing dependencies with retry logic..."
      - npm ci --include=dev --prefer-offline --no-audit || npm ci --include=dev --no-audit || (echo "âŒ npm install failed" && exit 1)
      - echo "ğŸ” Verifying critical files exist..."
      - test -f src/components/ui/toaster.tsx || (echo "âŒ Toaster component missing" && exit 1)
      - test -f src/hooks/use-toast.ts || (echo "âŒ useToast hook missing" && exit 1)
      - test -f src/components/ui/toast.tsx || (echo "âŒ Toast component missing" && exit 1)
      - echo "ğŸ”§ Rebuilding TypeScript path mapping..."
      - npx tsc --showConfig > tsconfig.debug.json || true
      - echo "ğŸ” Running comprehensive type checks..."
      - npm run typecheck || (echo "âŒ Type checking failed" && exit 1)
      - echo "ğŸ—ï¸ Building production application with enhanced error handling..."
      - NODE_ENV=production GENERATE_SOURCEMAP=false npm run build:production || (echo "âŒ Build failed" && cat /tmp/build.log && exit 1)
      - echo "ğŸ“Š Verifying build output..."
      - test -d dist/ || (echo "âŒ Build output directory not found" && exit 1)
      - test -f dist/index.html || (echo "âŒ Index.html not found in build output" && exit 1)
      - ls -la dist/
      - du -sh dist/
      - echo "ğŸ” Checking build artifacts..."
      - find dist/ -name "*.js" -exec du -sh {} \; | head -10
      - echo "âœ… Build completed successfully"
    post_build:
      - echo "ğŸ”§ Installing production server with fallback..."
      - npm install -g serve@latest || npm install -g serve@14.2.1 || (echo "âŒ Failed to install serve" && exit 1)
      - echo "ğŸ§ª Testing serve installation..."
      - serve --version || (echo "âŒ Serve installation verification failed" && exit 1)
      - echo "ğŸ” Final validation..."
      - test -x "$(command -v serve)" || (echo "âŒ Serve command not executable" && exit 1)
      - echo "ğŸ“ Build summary complete - All checks passed âœ…"

run:
  runtime-version: 18
  commands:
    web:
      - echo "ğŸš€ Starting QuantumVest Enterprise server..."
      - echo "ğŸ” Environment validation..."
      - echo "PORT: $PORT"
      - echo "NODE_ENV: $NODE_ENV"
      - test -d dist/ || (echo "âŒ Dist directory not found" && exit 1)
      - test -f dist/index.html || (echo "âŒ Index.html not found" && exit 1)
      - echo "âœ… Environment validation complete"
      - echo "ğŸŒ Starting web server on port $PORT..."
      - serve -s dist -l $PORT --no-clipboard --single --cors || (echo "âŒ Server startup failed" && exit 1)
  network:
    port: 8080
    env: PORT
  env:
    - name: NODE_ENV
      value: production
    - name: PORT
      value: 8080
    - name: GENERATE_SOURCEMAP
      value: false
    - name: REACT_APP_ENV
      value: production
    - name: CI
      value: true
    - name: DISABLE_ESLINT_PLUGIN
      value: true
    - name: TSC_COMPILE_ON_ERROR
      value: true
    - name: SKIP_PREFLIGHT_CHECK
      value: true
